name: Android CI

on:
  workflow_dispatch:
    inputs:
      build_suffix_choice:
        description: 'Sufixo de Versão (VERSION_SUFFIX)'
        required: false
        default: 'debug'
        type: choice
        options: [debug, release, emulator]
      runner_os:
        description: 'Runner OS'
        required: false
        default: 'ubuntu-latest'
        type: choice
        options: [ubuntu-latest, ubuntu-24.04, ubuntu-22.04]
      isdraft:
        description: 'This is a draft'
        required: true
        default: true
        type: boolean 
    
  push:
    branches: [master]

jobs:
  build:
    runs-on: ${{ github.event.inputs.runner_os || 'ubuntu-latest' }}
    env:
      VERSION_SUFFIX: ${{ github.event.inputs.build_suffix_choice || '' }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Decode Keystore (if present)
        if: ${{ secrets.SIGNING_KEY != '' }}
        env:
          ENCODED_KEYSTORE: ${{ secrets.SIGNING_KEY }}
          ENCODED_PROPS: ${{ secrets.KEYSTORE_PROPERTIES }}
        run: |
          echo "$ENCODED_KEYSTORE" | base64 -d > app/keystore.jks
          echo "$ENCODED_PROPS" | base64 -d > app/keystore.properties

      - name: Grant execute permission for gradlew (just in case)
        run: chmod +x ./gradlew

      - name: Build Emulator Release
        run: ./gradlew assembleEmulatorRelease

      - name: Prepare symbols artifact
        run: |
          mkdir -p artifact/mapping
          # Só copia se existir (release normalmente não tem native symbols)
          cp -r app/build/outputs/mapping/*/ artifact/mapping/ || true
          zip -r symbols.zip artifact/ || true

      - name: Get version from commit title ex= v2.3.4 Mensagem
        id: get_version
        run: |
          TITLE=$(git log -1 --pretty=format:"%s")
          VERSION=$(echo "$TITLE" | grep -o '^v[0-9]*\.[0-9]*\.[0-9]*' || echo "latest")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Draft GitHub Release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          automatic_release_tag: ${{ steps.get_version.outputs.version }}
          prerelease: false
          draft: ${{ github.event.inputs.isdraft }}
          title: ${{ steps.get_version.outputs.version }}
          files: |
            app/build/outputs/apk/emulator/release/*.apk
            symbols.zip

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: JL-Mod_${{ steps.get_version.outputs.version }}
          path: app/build/outputs/apk/emulator/release/*.apk

      - name: Upload Symbols Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Symbols_${{ steps.get_version.outputs.version }}
          path: symbols.zip
